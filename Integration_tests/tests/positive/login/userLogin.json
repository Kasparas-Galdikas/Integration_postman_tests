{
  "info": {
    "name": "positive - login - userLogin",
    "_postman_id": "pos-login-single-test",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json",
    "description": "Pozityvus prisijungimo testas su gilesniais assert'ais: registruoja vartotojÄ…, tikrina login login'Ä…, laukÅ³ tikslumÄ…, saugumÄ…, sesijos pokytÄ¯ ir edge-case bandymÄ…."
  },
  "item": [
    {
      "name": "Prisijungimas â€“ sÄ—kmÄ— (POST /login)",
      "event": [
        {
          "listen": "prerequest",
          "script": {
            "type": "text/javascript",
            "exec": [
              "// ðŸ”§ DinaminÄ—s reikÅ¡mÄ—s, kad testas bÅ«tÅ³ kartotinas",
              "const id = Date.now();",
              "pm.collectionVariables.set('loginUsername', `user_pos_login_${id}`);",
              "pm.collectionVariables.set('loginFullName', 'User Positive Login');",
              "pm.collectionVariables.set('loginEmail', `poslogin_${id}@example.com`);",
              "pm.collectionVariables.set('loginPassword', 'secret1');",
              "",
              "// Numatytasis baseUrl",
              "if (!pm.environment.get('baseUrl') && !pm.collectionVariables.get('baseUrl')) {",
              "  pm.collectionVariables.set('baseUrl', 'http://localhost:3000');",
              "}",
              "",
              "// UÅ¾registruojame vartotojÄ… prieÅ¡ login",
              "const base = pm.environment.get('baseUrl') || pm.collectionVariables.get('baseUrl');",
              "pm.sendRequest({",
              "  url: `${base}/register`,",
              "  method: 'POST',",
              "  header: { 'Content-Type': 'application/json' },",
              "  body: {",
              "    mode: 'raw',",
              "    raw: JSON.stringify({",
              "      username: pm.collectionVariables.get('loginUsername'),",
              "      fullName: pm.collectionVariables.get('loginFullName'),",
              "      email: pm.collectionVariables.get('loginEmail'),",
              "      password: pm.collectionVariables.get('loginPassword')",
              "    })",
              "  }",
              "});"
            ]
          }
        },
        {
          "listen": "test",
          "script": {
            "type": "text/javascript",
            "exec": [
              "// === 1) Status ===",
              "pm.test('Status 200 (OK)', () => pm.response.to.have.status(200));",
              "",
              "// === 2) Content-Type JSON ===",
              "pm.test('Content-Type yra JSON', () => {",
              "  const ctype = pm.response.headers.get('Content-Type');",
              "  pm.expect(ctype).to.match(/^application\\/json\\b/i);",
              "});",
              "",
              "const body = pm.response.json();",
              "",
              "// === 3) message + user struktÅ«ra ===",
              "pm.test('Atsakymas turi message ir user laukus', () => {",
              "  pm.expect(body).to.have.property('message');",
              "  pm.expect(body).to.have.property('user');",
              "});",
              "",
              "// === 4) User laukÅ³ struktÅ«ra: turi TIK 3 laukus ===",
              "pm.test('user turi TIK username/email/fullName laukus', () => {",
              "  const expected = ['username', 'email', 'fullName'];",
              "  pm.expect(Object.keys(body.user)).to.have.members(expected);",
              "});",
              "",
              "// === 5) Password saugumas: neturi bÅ«ti niekur ===",
              "pm.test('Atsakyme nÄ—ra jokio password lauko', () => {",
              "  const responseText = pm.response.text();",
              "  pm.expect(responseText.toLowerCase()).to.not.include('password');",
              "});",
              "",
              "// === 6) Tiksliai sutampa su registruotais (STRICT match) ===",
              "pm.test('Login atsakymas STRICT sutampa su registruotais duomenimis', () => {",
              "  pm.expect(body.user).to.eql({",
              "    username: pm.collectionVariables.get('loginUsername'),",
              "    fullName: pm.collectionVariables.get('loginFullName'),",
              "    email: pm.collectionVariables.get('loginEmail')",
              "  });",
              "});",
              "",
              "// === 7) Endpoint verifikacija ===",
              "pm.test('Teisingas endpoint (/login)', () => {",
              "  pm.expect(pm.request.url.getPath()).to.match(/\\/login$/);",
              "});",
              "",
              "// === 8) loggedInUser pasikeitÄ— (netiesioginis testas per GET /user) ===",
              "pm.test('loggedInUser pasikeitÄ— (GET /user patvirtina)', (done) => {",
              "  const base = pm.collectionVariables.get('baseUrl');",
              "  const username = pm.collectionVariables.get('loginUsername');",
              "",
              "  pm.sendRequest({ url: `${base}/user/${username}`, method: 'GET' }, (err, res) => {",
              "    pm.expect(res.code).to.equal(200);",
              "    const j = res.json();",
              "    pm.expect(j.username).to.eql(username);",
              "    pm.expect(j).to.not.have.property('password');",
              "    done();",
              "  });",
              "});",
              "",
              "// === 9) Login edge-case: su tarpais neturi veikti ===",
              "pm.test('Login su papildomais tarpais NEGALI veikti', (done) => {",
              "  const base = pm.collectionVariables.get('baseUrl');",
              "  const badUsername = '   ' + pm.collectionVariables.get('loginUsername') + '   ';",
              "",
              "  pm.sendRequest({",
              "    url: `${base}/login`,",
              "    method: 'POST',",
              "    header: { 'Content-Type': 'application/json' },",
              "    body: {",
              "      mode: 'raw',",
              "      raw: JSON.stringify({",
              "        username: badUsername,",
              "        password: pm.collectionVariables.get('loginPassword')",
              "      })",
              "    }",
              "  }, (err, res) => {",
              "    pm.expect(res.code).to.equal(401);",
              "    done();",
              "  });",
              "});"
            ]
          }
        }
      ],
      "request": {
        "method": "POST",
        "header": [
          { "key": "Content-Type", "value": "application/json" }
        ],
        "url": {
          "raw": "{{baseUrl}}/login",
          "host": ["{{baseUrl}}"],
          "path": ["login"]
        },
        "body": {
          "mode": "raw",
          "raw": "{\n  \"username\": \"{{loginUsername}}\",\n  \"password\": \"{{loginPassword}}\"\n}"
        },
        "description": "Prisijungimo sÄ—kmÄ—s scenarijus su pilnais gilesniais testais."
      },
      "response": []
    }
  ],
  "variable": [
    { "key": "baseUrl", "value": "http://localhost:3000" }
  ]
}
