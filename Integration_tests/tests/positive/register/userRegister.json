{
  "info": {
    "name": "positive - register - userRegister",
    "_postman_id": "pos-register-single-test",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json",
    "description": "Pozityvus registracijos testas su giliu validavimu: tikrina struktūrą, laukų tikslumą, password nebuvimą, escape/trim veikimą ir users masyvo padidėjimą."
  },
  "item": [
    {
      "name": "Registracija – sėkmė (POST /register)",
      "event": [
        {
          "listen": "prerequest",
          "script": {
            "type": "text/javascript",
            "exec": [
              "const id = Date.now();",
              "pm.collectionVariables.set('regUsername', `user_pos_reg_${id}`);",
              "pm.collectionVariables.set('regFullName', '  <script>alert(1)</script>  ');",
              "pm.collectionVariables.set('regEmail', `posreg_${id}@example.com`);",
              "pm.collectionVariables.set('regPassword', 'secret1');",
              "",
              "const base = pm.environment.get('baseUrl') || pm.collectionVariables.get('baseUrl') || 'http://localhost:3000';",
              "pm.collectionVariables.set('baseUrl', base);",
              "",
              "pm.sendRequest({ url: `${base}/users`, method: 'GET' }, (err, res) => {",
              "  const arr = res.json();",
              "  pm.collectionVariables.set('usersBefore', arr.length);",
              "});"
            ]
          }
        },
        {
          "listen": "test",
          "script": {
            "type": "text/javascript",
            "exec": [
              "// 1) Status",
              "pm.test('Status 201 (sukurta)', () => pm.response.to.have.status(201));",
              "",
              "// 2) JSON response",
              "pm.test('Content-Type yra JSON', () => {",
              "  pm.expect(pm.response.headers.get('Content-Type')).to.match(/^application\\/json/i);",
              "});",
              "const body = pm.response.json();",
              "",
              "// 3) Base structure",
              "pm.test('Atsakymas turi message ir user', () => {",
              "  pm.expect(body).to.have.property('message');",
              "  pm.expect(body).to.have.property('user');",
              "});",
              "",
              "// 4) Tik 3 laukų ir be password",
              "pm.test('User turi TIK username/email/fullName laukus', () => {",
              "  pm.expect(Object.keys(body.user)).to.have.members(['username', 'email', 'fullName']);",
              "});",
              "pm.test('Atsakyme nėra jokio password lauko', () => {",
              "  pm.expect(pm.response.text().toLowerCase()).to.not.include('password');",
              "});",
              "",
              "// 5) STRICT equality",
              "pm.test('User STRICT sutampa su siųstais duomenimis (po escape/trim)', () => {",
              "  const expectedFullName = '&lt;script&gt;alert(1)&lt;&#x2F;script&gt;';",
              "  pm.expect(body.user).to.eql({",
              "    username: pm.collectionVariables.get('regUsername'),",
              "    email: pm.collectionVariables.get('regEmail'),",
              "    fullName: expectedFullName",
              "  });",
              "});",
              "",
              "// 6) Escape test (express-validator.escape realus rezultatas)",
              "pm.test('FullName escape patikrintas', () => {",
              "  pm.expect(body.user.fullName).to.equal('&lt;script&gt;alert(1)&lt;&#x2F;script&gt;');",
              "});",
              "",
              "// 7) Trim test",
              "pm.test('FullName buvo apkarpytas (trim)', () => {",
              "  pm.expect(body.user.fullName.startsWith(' ')).to.be.false;",
              "  pm.expect(body.user.fullName.endsWith(' ')).to.be.false;",
              "});",
              "",
              "// 8) Endpoint correctness",
              "pm.test('Teisingas endpoint (/register)', () => {",
              "  pm.expect(pm.request.url.getPath()).to.match(/\\/register$/);",
              "});",
              "",
              "// 9) Confirm user exists via GET /user/:username",
              "const base = pm.collectionVariables.get('baseUrl');",
              "const u = pm.collectionVariables.get('regUsername');",
              "",
              "pm.sendRequest({ url: `${base}/user/${u}`, method: 'GET' }, (err, res) => {",
              "  const j = res.json();",
              "  pm.test('GET /user/:username grąžina 200', () => pm.expect(res.code).to.equal(200));",
              "  pm.test('GET grąžina TIK 3 laukus', () => {",
              "    pm.expect(Object.keys(j)).to.have.members(['username', 'email', 'fullName']);",
              "  });",
              "});",
              "",
              "// 10) Confirm users list increased",
              "pm.sendRequest({ url: `${base}/users`, method: 'GET' }, (err, res) => {",
              "  const arr = res.json();",
              "  const before = Number(pm.collectionVariables.get('usersBefore'));",
              "  pm.test('users masyvas padidėjo 1 vnt.', () => {",
              "    pm.expect(arr.length).to.equal(before + 1);",
              "  });",
              "  pm.test('Naujai registruotas vartotojas yra masyve', () => {",
              "    const exists = arr.some(u => u.username === pm.collectionVariables.get('regUsername'));",
              "    pm.expect(exists).to.be.true;",
              "  });",
              "});"
            ]
          }
        }
      ],
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          }
        ],
        "url": {
          "raw": "{{baseUrl}}/register",
          "host": [
            "{{baseUrl}}"
          ],
          "path": [
            "register"
          ]
        },
        "body": {
          "mode": "raw",
          "raw": "{\n  \"username\": \"{{regUsername}}\",\n  \"fullName\": \"{{regFullName}}\",\n  \"email\": \"{{regEmail}}\",\n  \"password\": \"{{regPassword}}\"\n}"
        },
        "description": "Išplėstinis registracijos testas su escape, trim, security ir users state tikrinimu."
      },
      "response": []
    }
  ],
  "variable": [
    {
      "key": "baseUrl",
      "value": "http://localhost:3000"
    }
  ]
}
