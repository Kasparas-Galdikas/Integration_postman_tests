{
  "info": {
    "name": "positive - user - getUsers",
    "_postman_id": "pos-user-list",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json",
    "description": "Pozityvus GET /users testas su deep validation: strict laukai, XSS escape, trim testai, password anti-leak ir strict equality."
  },
  "item": [
    {
      "name": "Gauti visus vartotojus – sėkmė (GET /users)",
      "event": [
        {
          "listen": "prerequest",
          "script": {
            "type": "text/javascript",
            "exec": [
              "// Unikalūs duomenys",
              "const id = Date.now();",
              "pm.collectionVariables.set('u1', `user_pos_list1_${id}`);",
              "pm.collectionVariables.set('u2', `user_pos_list2_${id}`);",
              "",
              "// XSS ir trim testams",
              "pm.collectionVariables.set('u1_full_raw', '   <script>Hi1</script>   ');",
              "pm.collectionVariables.set('u2_full_raw', '   <script>Hi2</script>   ');",
              "",
              "// Expected escaped (pagal express-validator.escape())",
              "const esc1 = '&lt;script&gt;Hi1&lt;&#x2F;script&gt;';",
              "const esc2 = '&lt;script&gt;Hi2&lt;&#x2F;script&gt;';",
              "pm.collectionVariables.set('u1_full_expected', esc1);",
              "pm.collectionVariables.set('u2_full_expected', esc2);",
              "",
              "// Emailai",
              "pm.collectionVariables.set('u1_email', `poslist1_${id}@example.com`);",
              "pm.collectionVariables.set('u2_email', `poslist2_${id}@example.com`);",
              "",
              "// Užtikriname baseUrl",
              "if (!pm.environment.get('baseUrl') && !pm.collectionVariables.get('baseUrl')) {",
              "  pm.collectionVariables.set('baseUrl', 'http://localhost:3000');",
              "}",
              "const base = pm.environment.get('baseUrl') || pm.collectionVariables.get('baseUrl');",
              "",
              "// Registruojame abu vartotojus",
              "const register = (username, fullName, email) => {",
              "  pm.sendRequest({",
              "    url: `${base}/register`,",
              "    method: 'POST',",
              "    header: { 'Content-Type': 'application/json' },",
              "    body: {",
              "      mode: 'raw',",
              "      raw: JSON.stringify({",
              "        username,",
              "        fullName,",
              "        email,",
              "        password: 'secret1'",
              "      })",
              "    }",
              "  });",
              "};",
              "",
              "register(pm.collectionVariables.get('u1'), pm.collectionVariables.get('u1_full_raw'), pm.collectionVariables.get('u1_email'));",
              "register(pm.collectionVariables.get('u2'), pm.collectionVariables.get('u2_full_raw'), pm.collectionVariables.get('u2_email'));"
            ]
          }
        },
        {
          "listen": "test",
          "script": {
            "type": "text/javascript",
            "exec": [
              "// 1) Status",
              "pm.test('Status 200', () => pm.response.to.have.status(200));",
              "",
              "// 2) JSON header",
              "pm.test('Content-Type yra JSON', () => {",
              "  pm.expect(pm.response.headers.get('Content-Type')).to.match(/^application\\/json/i);",
              "});",
              "",
              "// 3) Response yra masyvas",
              "const arr = pm.response.json();",
              "pm.test('Atsakymas yra masyvas', () => pm.expect(arr).to.be.an('array'));",
              "",
              "// 4) Password neturi būti NIEKUR visame tekste",
              "pm.test('Nėra password visame response', () => {",
              "  pm.expect(pm.response.text().toLowerCase()).to.not.include('password');",
              "});",
              "",
              "// 5) Kiekvienas user turi TIK šiuos laukus",
              "pm.test('Kiekvienas user turi tik username/email/fullName', () => {",
              "  arr.forEach(u => {",
              "    pm.expect(Object.keys(u)).to.have.members(['username', 'email', 'fullName']);",
              "  });",
              "});",
              "",
              "// 6) Turi būti abu naujai sukurti vartotojai",
              "pm.test('Masive yra u1 ir u2', () => {",
              "  const usernames = arr.map(u => u.username);",
              "  pm.expect(usernames).to.include(pm.collectionVariables.get('u1'));",
              "  pm.expect(usernames).to.include(pm.collectionVariables.get('u2'));",
              "});",
              "",
              "// 7) STRICT equality naujiems vartotojams",
              "pm.test('u1 STRICT equality', () => {",
              "  const u = arr.find(x => x.username === pm.collectionVariables.get('u1'));",
              "  pm.expect(u).to.eql({",
              "    username: pm.collectionVariables.get('u1'),",
              "    email: pm.collectionVariables.get('u1_email'),",
              "    fullName: pm.collectionVariables.get('u1_full_expected')",
              "  });",
              "});",
              "",
              "pm.test('u2 STRICT equality', () => {",
              "  const u = arr.find(x => x.username === pm.collectionVariables.get('u2'));",
              "  pm.expect(u).to.eql({",
              "    username: pm.collectionVariables.get('u2'),",
              "    email: pm.collectionVariables.get('u2_email'),",
              "    fullName: pm.collectionVariables.get('u2_full_expected')",
              "  });",
              "});",
              "",
              "// 8) XSS escape test",
              "pm.test('XSS escape suveikė abu kartus', () => {",
              "  const u1 = arr.find(x => x.username === pm.collectionVariables.get('u1'));",
              "  const u2 = arr.find(x => x.username === pm.collectionVariables.get('u2'));",
              "  pm.expect(u1.fullName).to.equal(pm.collectionVariables.get('u1_full_expected'));",
              "  pm.expect(u2.fullName).to.equal(pm.collectionVariables.get('u2_full_expected'));",
              "});",
              "",
              "// 9) Trim test",
              "pm.test('Trim suveikė visiems vartotojams', () => {",
              "  arr.forEach(u => {",
              "    pm.expect(u.fullName.startsWith(' ')).to.be.false;",
              "    pm.expect(u.fullName.endsWith(' ')).to.be.false;",
              "  });",
              "});",
              "",
              "// 10) Teisingas endpoint",
              "pm.test('Teisingas endpoint (/users)', () => {",
              "  pm.expect(pm.request.url.getPath()).to.eql('/users');",
              "});"
            ]
          }
        }
      ],
      "request": {
        "method": "GET",
        "url": {
          "raw": "{{baseUrl}}/users",
          "host": ["{{baseUrl}}"],
          "path": ["users"]
        }
      },
      "response": []
    }
  ],
  "variable": [
    {
      "key": "baseUrl",
      "value": "http://localhost:3000"
    }
  ]
}
